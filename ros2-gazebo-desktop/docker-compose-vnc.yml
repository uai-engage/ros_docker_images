# Docker Compose for Remote Server with VNC (Better Performance)
# Use this instead of X11 forwarding for faster GUI performance

services:
  ros2-gazebo-vnc:
    build:
      context: .
      dockerfile: Dockerfile.vnc
      args:
        USERNAME: ${USERNAME:-rosuser}
        USER_UID: ${USER_UID:-1000}
        USER_GID: ${USER_GID:-1000}
    image: ros2-gazebo-desktop:jazzy-vnc
    container_name: ${CONTAINER_NAME:-ros2_gazebo_vnc}

    stdin_open: true
    tty: true

    environment:
      - VNC_PASSWORD=${VNC_PASSWORD:-rospassword}
      - VNC_RESOLUTION=${VNC_RESOLUTION:-1920x1080}
      - VNC_DEPTH=${VNC_DEPTH:-24}
      - ROS_DOMAIN_ID=${ROS_DOMAIN_ID:-0}
      - RMW_IMPLEMENTATION=${RMW_IMPLEMENTATION:-rmw_fastrtps_cpp}
      - GZ_SIM_RESOURCE_PATH=${GZ_SIM_RESOURCE_PATH:-/home/rosuser/ros2_ws/src/models}
      - GZ_PARTITION=${GZ_PARTITION:-gazebo}
      - XDG_RUNTIME_DIR=/tmp/runtime-${USERNAME:-rosuser}
      # Software rendering for non-GPU servers
      - LIBGL_ALWAYS_SOFTWARE=1

    volumes:
      - ${HOST_WORKSPACE:-./ros2_ws}:/home/${USERNAME:-rosuser}/ros2_ws:rw
      - /dev/shm:/dev/shm

    # Expose VNC and noVNC ports
    ports:
      - "5901:5901"    # VNC port
      - "6080:6080"    # noVNC web interface

    # Use bridge network for port exposure
    network_mode: bridge

    shm_size: '2gb'

    deploy:
      resources:
        limits:
          memory: 8G
        reservations:
          memory: 4G

    working_dir: /home/${USERNAME:-rosuser}/ros2_ws

    command: /startup-vnc.sh
